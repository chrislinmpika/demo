steps:
- id: 'build-container'
  name: 'gcr.io/cloud-builders/docker'
  args:
  - 'build'
  - '-t'
  - '$_FULL_BUILD_NAME:$_TAG_PREFIX$SHORT_SHA'
  - '.'
  waitFor: ['-']

- id: 'update-image-tag'
  name: 'alpine'
  entrypoint: '/bin/sh'
  args:
  - '-c'
  - |
      # Ensure git is configured with user details for commit
      git config --global user.name "Cloudbuild"

      # Update the image tag in helm/values.yaml
      sed -i '' 's|tag:.*|tag: "'${SHORT_SHA}'"|' helm/values.yaml
      
      # Commit and push the changes
      git add helm/values.yaml
      git commit -m "Update image tag to $_SHORT_SHA"
      git push origin HEAD:$_BRANCH_NAME
  env:
  - 'SHORT_SHA=$_SHORT_SHA'
  - 'BRANCH_NAME=$_BRANCH_NAME'
  waitFor:
  - 'build-container'

images:
- '$_FULL_BUILD_NAME:$_TAG_PREFIX$SHORT_SHA'

substitutions:
  _FULL_BUILD_NAME: 'europe-west4-docker.pkg.dev/kiro-ops-staging/kiro-ops-staging-docker-repository/demo'
  _GIT_REPOSITORY: 'https://github.com/chrislinmpika/demo.git'
